name: Build All PHP Versions (ARM64)

on:
  push:
    branches:
      - "**"     # Har branch pe run hoga
  workflow_dispatch:

jobs:

  generate-matrix:
    runs-on: macos-14
    outputs:
      versions: ${{ steps.set-matrix.outputs.versions }}

    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          VERSIONS=$(grep -v '^#' versions/php-versions.txt | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT

  build:
    needs: generate-matrix
    runs-on: macos-14

    strategy:
      fail-fast: true   # üî• 1 fail ‚Üí sab cancel
      matrix:
        php_version: ${{ fromJson(needs.generate-matrix.outputs.versions) }}

    steps:
      - uses: actions/checkout@v4

      - name: Make build script executable
        run: chmod +x scripts/build-php.sh

      - name: Verify downloads
        run: |
          echo "PHP Sources:"
          ls -lah downloads/php | head
          echo ""
          echo "Dependencies:"
          ls -lah downloads/deps | head

      - name: Build PHP
        run: bash scripts/build-php.sh ${{ matrix.php_version }}

      - name: Test PHP
        run: |
          PHP_PATH=./output-${{ matrix.php_version }}/php-${{ matrix.php_version }}-arm64/bin/php
          if [ ! -f "$PHP_PATH" ]; then
            echo "‚ùå PHP binary not found"
            exit 1
          fi

          echo "PHP Version:"
          $PHP_PATH -v

          echo ""
          echo "Loaded Extensions:"
          $PHP_PATH -m | grep -i opcache

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php_version }}-arm64
          path: output-${{ matrix.php_version }}/php-${{ matrix.php_version }}-arm64.zip