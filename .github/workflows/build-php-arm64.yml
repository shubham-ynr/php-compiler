name: Build All PHP Versions (ARM64 Sequential)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make build script executable
        run: chmod +x scripts/build-php.sh

      - name: Verify downloads
        run: |
          echo "ðŸ“¦ PHP Sources:"
          ls -lah downloads/php || true
          echo ""
          echo "ðŸ“¦ Dependencies:"
          ls -lah downloads/deps || true

      - name: Build All Versions Sequentially
        run: |
          set -e

          while read VERSION; do
            if [[ -z "$VERSION" || "$VERSION" =~ ^# ]]; then
              continue
            fi

            echo ""
            echo "========================================"
            echo "ðŸš€ Building PHP $VERSION"
            echo "========================================"

            bash scripts/build-php.sh $VERSION

            echo ""
            echo "ðŸ§ª Testing PHP $VERSION"

            PHP_PATH=./output-$VERSION/php-$VERSION-arm64/bin/php

            if [ ! -f "$PHP_PATH" ]; then
              echo "âŒ PHP binary not found for $VERSION"
              exit 1
            fi

            $PHP_PATH -v
            $PHP_PATH -m | grep -i opcache || true

            echo ""
            echo "ðŸ“¦ Uploading artifact for $VERSION"

            echo "VERSION=$VERSION" >> $GITHUB_ENV

          done < versions/php-versions.txt

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: php-builds-arm64
          path: |
            output-*/php-*-arm64.zip