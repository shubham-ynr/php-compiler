name: PHP Offline Builder ARM64

on:
  push:

jobs:
  build:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Download Sources
        run: |
          chmod +x scripts/download.sh
          bash scripts/download.sh

      - name: Build Toolchain
        run: |
          chmod +x scripts/build-toolchain.sh
          bash scripts/build-toolchain.sh

      - name: Build PHP Sequentially
        run: |
          chmod +x scripts/build-php.sh
          while read V; do
            [[ -z "$V" || "$V" =~ ^# ]] && continue
            bash scripts/build-php.sh "$V"
          done < versions/php-versions.txt

      - name: Build PECL
        run: |
          chmod +x scripts/build-pecl.sh
          while read V; do
            [[ -z "$V" || "$V" =~ ^# ]] && continue
            bash scripts/build-pecl.sh "output-$V/php-$V-arm64"
          done < versions/php-versions.txt

      - name: Verify
        run: |
          while read V; do
            [[ -z "$V" || "$V" =~ ^# ]] && continue
            output-$V/php-$V-arm64/bin/php -v
          done < versions/php-versions.txt

      - name: Archive
        run: |
          for dir in output-*; do
            zip -r $dir.zip $dir
          done

      - uses: actions/upload-artifact@v4
        with:
          name: php-builds
          path: output-*.zip